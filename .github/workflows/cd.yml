name: CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    environment: labo04

    steps:
      - name: Checkout depot
        uses: actions/checkout@v4
        with:
          # Using clean: true is generally safer to avoid leftover artifacts
          clean: true 

      - name: Creates .env file
        run: |
          # Quoting 'EOF' prevents shell expansion of secrets
          cat > .env << 'EOF'
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.MYSQL_DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          REDIS_DB=${{ secrets.REDIS_DB }}
          EOF

      - name: Creates docker network
        run: docker network create labo03-network || true

      - name: Deploys with docker compose
        run: |
          # --remove-orphans cleans up services removed from the yaml
          docker compose down --remove-orphans
          # --pull ensures you have the latest base images
          docker compose build --pull
          # --force-recreate ensures containers are restarted with new code/env
          docker compose up -d --force-recreate

      - name: Verify that containers are running
        run: |
          docker ps
          sleep 5
          docker compose ps