name: CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    environment: labo04

    steps:
      - name: Checkout depot
        uses: actions/checkout@v4
        with:
          # Using clean: true is generally safer to avoid leftover artifacts
          clean: true 

      - name: Creates .env file
        run: |
          # Quoting 'EOF' prevents shell expansion of secrets
          cat > .env << 'EOF'
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.MYSQL_DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          REDIS_DB=${{ secrets.REDIS_DB }}
          EOF

      - name: Creates docker network
        run: docker network create labo03-network || true

      - name: Deploys with docker compose
        run: |
          # 1. Pull the latest images defined in your yaml
          docker compose pull
          
          # 2. Shut down and remove orphans
          docker compose down --remove-orphans
          
          # 3. Build and Start
          # -d runs in background, --build ensures local changes are baked in
          docker compose up -d --build --force-recreate

      - name: Verify that containers are running
        run: |
          docker ps
          sleep 5
          docker compose ps